
#
# olsr.org makefile
# $Id: Makefile,v 1.11 2004/11/04 20:25:05 kattemat Exp $
#

CC ?= gcc
MAKE ?= make

CFLAGS ?= -Isrc -Wall -Wmissing-prototypes -Wstrict-prototypes -O2 -g #-pg -DDEBUG #-march=i686
LIBS = -lpthread -lm -ldl
INSTALL_PREFIX ?=
STRIP ?= strip
BISON ?= bison
FLEX ?= flex
CFGDIR = src/cfgparser

DEPFILE = .linux-depend
DEPEND= makedepend -Dlinux -Y -f $(DEPFILE) -- $(CFLAGS)

SRCS= $(wildcard src/*.c) \
      $(wildcard src/linux/*.c) \
      $(CFGDIR)/oparse.c $(CFGDIR)/oscan.c $(CFGDIR)/olsrd_conf.c

HDRS= $(wildcard src/*.h) \
      $(wildcard src/linux/*.h) \
      $(CFGDIR)/oparse.h $(CFGDIR)/olsrd_conf.h

OBJS= $(patsubst %.c,%.o,$(wildcard src/*.c)) \
      $(patsubst %.c,%.o,$(wildcard src/linux/*.c)) \
      $(CFGDIR)/oparse.o $(CFGDIR)/oscan.o $(CFGDIR)/olsrd_conf.o


all:	olsrd

olsrd:	$(OBJS)
	$(CC) $(LIBS) -o bin/$@ $(OBJS)

depend:
	rm -f $(DEPFILE)
	$(MAKE) $(DEPFILE)


$(DEPFILE):
	@echo '# olsrd dependency file. AUTOGENERATED' > $(DEPFILE)
	$(DEPEND) -- $(SRCS) >&/dev/null


$(CFGDIR)/oparse.c: $(CFGDIR)/oparse.y $(CFGDIR)/olsrd_conf.h
	$(BISON) -d -o$(CFGDIR)/oparse.c $(CFGDIR)/oparse.y

$(CFGDIR)/oparse.h: $(CFGDIR)/oparse.c


$(CFGDIR)/oscan.c: $(CFGDIR)/oscan.lex $(CFGDIR)/oparse.h $(CFGDIR)/olsrd_conf.h
	$(FLEX) -o$(CFGDIR)/oscan.c $(CFGDIR)/oscan.lex

libs: 
	for i in lib/*; do \
		$(MAKE) -C $$i; \
	done; 

clean_libs: 
	for i in lib/*; do \
		$(MAKE) -C $$i clean; \
	done; 

.PHONY: clean
clean:
	rm -f $(OBJS)

uberclean:
	rm -f $(OBJS) $(DEPFILE) 
	rm -f $(CFGDIR)/oscan.c $(CFGDIR)/oparse.h $(CFGDIR)/oparse.c
	rm -f bin/olsrd
	rm -f src/*~ src/linux/*~ src/cfgparser/*~

install_libs:
	for i in lib/*; do \
		$(MAKE) -C $$i LIBDIR=$(INSTALL_PREFIX)/usr/lib install; \
	done; 	


install_bin:
	$(STRIP) bin/olsrd
	install -D -m 755 bin/olsrd $(INSTALL_PREFIX)/usr/sbin/olsrd

install: install_bin
	@echo olsrd uses the configfile $(INSTALL_PREFIX)/etc/olsr.conf
	@echo a default configfile. A sample configfile
	@echo can be installed
	mkdir -p $(INSTALL_PREFIX)/etc
	cp -i files/olsrd.conf.default $(INSTALL_PREFIX)/etc/olsrd.conf
	@echo -------------------------------------------
	@echo Edit $(INSTALL_PREFIX)/etc/olsrd.conf before running olsrd!!
	@echo -------------------------------------------
	mkdir -p $(INSTALL_PREFIX)/usr/share/man/man8/
	cp files/olsrd.8.gz $(INSTALL_PREFIX)/usr/share/man/man8/olsrd.8.gz


sinclude $(DEPFILE)
